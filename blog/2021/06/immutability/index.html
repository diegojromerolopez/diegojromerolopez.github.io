<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Immutability | Diego J.&#39;s Software Tar Pit</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Introduction In this post I will explain the rationale about working with immutable objects and will present a personal project I&rsquo;ve been working on the last few days: Gelidum.
La nevada by Francisco de Goya
Why immutability? Nowadays, most processors have some kind of parallelism or concurrency embeded in themselves. Single-flow-execution software is limited by the lowest speed unit in the system. There are some solutions that try to hide the wait for these slow sub-systems by computing in other execution-flows (threads or processes).">
    <meta name="generator" content="Hugo 0.104.3" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      
<link rel="shortcut icon" href="/static/images/favicon.ico" type="image/x-icon" />


    

    
    
    <meta property="og:title" content="Immutability" />
<meta property="og:description" content="Introduction In this post I will explain the rationale about working with immutable objects and will present a personal project I&rsquo;ve been working on the last few days: Gelidum.
La nevada by Francisco de Goya
Why immutability? Nowadays, most processors have some kind of parallelism or concurrency embeded in themselves. Single-flow-execution software is limited by the lowest speed unit in the system. There are some solutions that try to hide the wait for these slow sub-systems by computing in other execution-flows (threads or processes)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://diegojromerolopez.github.io/blog/2021/06/immutability/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-06-06T00:00:00+00:00" />

<meta itemprop="name" content="Immutability">
<meta itemprop="description" content="Introduction In this post I will explain the rationale about working with immutable objects and will present a personal project I&rsquo;ve been working on the last few days: Gelidum.
La nevada by Francisco de Goya
Why immutability? Nowadays, most processors have some kind of parallelism or concurrency embeded in themselves. Single-flow-execution software is limited by the lowest speed unit in the system. There are some solutions that try to hide the wait for these slow sub-systems by computing in other execution-flows (threads or processes)."><meta itemprop="datePublished" content="2021-06-06T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-06-06T00:00:00+00:00" />
<meta itemprop="wordCount" content="940">
<meta itemprop="keywords" content="immutability,python,project," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Immutability"/>
<meta name="twitter:description" content="Introduction In this post I will explain the rationale about working with immutable objects and will present a personal project I&rsquo;ve been working on the last few days: Gelidum.
La nevada by Francisco de Goya
Why immutability? Nowadays, most processors have some kind of parallelism or concurrency embeded in themselves. Single-flow-execution software is limited by the lowest speed unit in the system. There are some solutions that try to hide the wait for these slow sub-systems by computing in other execution-flows (threads or processes)."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Diego J.&#39;s Software Tar Pit
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="" title="Blog page">
              Blog
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="page/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="tags" title="Tags page">
              Tags
            </a>
          </li>
          
        </ul>
      
      
<div class="ananke-socials">
  
    <a href="true" target="_blank" class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel="noopener" aria-label="follow on RSS——Opens in a new window">
      
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path id="scale" d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>

</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Immutability</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-06-06T00:00:00Z">June 6, 2021</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="introduction">Introduction</h1>
<p>In this post I will explain the rationale about working with immutable objects
and will present a personal project I&rsquo;ve been working on the last few days:
<a href="https://github.com/diegojromerolopez/gelidum">Gelidum</a>.</p>
<p><img src="/static/images/la-nevada-goya.jpeg" alt="La nevada, painted by Francisco de Goya" title="La nevada by Francisco de Goya">
<em>La nevada by Francisco de Goya</em></p>
<h1 id="why-immutability">Why immutability?</h1>
<p>Nowadays, most processors have some kind of parallelism or concurrency
embeded in themselves. Single-flow-execution software is limited by
the lowest speed unit in the system. There are some solutions that
try to hide the wait for these slow sub-systems by computing in other
execution-flows (threads or processes).</p>
<p>However, this creates the problem of sharing information between
the different execution-flows. Most parallel libraries are based
on message-passing (as their processes can be in different memory spaces). But, how about the concurrency systems? They usually
share the same memory banks, should be have to share the variables
between threads? It is not recommended as coordinating the editions of the variables can be extremely difficult, so most solutions push for communitating threads by messages or sharing immutable data
(our approach here).</p>
<h1 id="introducing-gelidum">Introducing Gelidum</h1>
<p><a href="https://github.com/diegojromerolopez/gelidum">Gelidum</a> (pronounced <em>ye-lee-doom</em>,
meaning <em>frozen</em> in latin) is a <a href="https://pypi.org/project/gelidum/">python package</a>
that allows you to freeze and object (and all of its references), making it immutable.
What does it mean to be immutable? All attributes of this object cannot have their values
changed. Further, this <em>freezing</em> is a <strong>deep</strong> freeze, meaning that all the attributes
that are objects will also be frozen, and the attributes of each of this attributes and
so on. Any object referenced by this object or one of its descendents will be frozen.</p>
<h1 id="how-did-you-do-this">How did you do this?</h1>
<p>The idea of Gelidum is remove all attributes that can modify the current attributes of an
instance or that can add new attributes.</p>
<p>The core of this project is <a href="https://github.com/diegojromerolopez/gelidum/blob/main/gelidum/frozen.py">a function that creates a frozen-version of a class</a>.
This froze-version has all setting-attr
(<a href="https://docs.python.org/3/reference/datamodel.html#object.__setattr__">__setattr__</a>,
<a href="https://docs.python.org/3/reference/datamodel.html#object.__set__">__set__</a>,
<a href="https://docs.python.org/3/reference/datamodel.html#object.__delattr__">__delattr__</a>,
<a href="https://docs.python.org/3/reference/datamodel.html#object.__setitem__">__setitem__</a>,
<a href="https://docs.python.org/3/reference/datamodel.html#object.__delitem__">__delitem__</a>,
<a href="https://docs.python.org/3/reference/datamodel.html#object.__reversed__">__reversed__</a>) methods overwritten by an exception-raising method.</p>
<p>It also has an empty <a href="https://docs.python.org/3/reference/datamodel.html#slots">__slots__</a> class-attribute to avoid adding new attributes.</p>
<p>And finally, it overwrites the contents of writtable attributes (i.e. the <a href="https://docs.python.org/3/library/stdtypes.html#object.__dict__">__dict__</a> dictionary) by assigning None to their values, making them unwrittable, and hence forcing the developer to access the
attributes directly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FrozenBase</span>(object):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __setattr__(self, key, value):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> FrozenException(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Can&#39;t assign &#39;</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; on immutable instance&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __set__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> FrozenException(<span style="color:#e6db74">&#34;Can&#39;t assign setter on immutable instance&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __delattr__(self, name):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> FrozenException(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Can&#39;t delete attribute &#39;</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; on immutable instance&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __setitem__(self, key, value):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> FrozenException(<span style="color:#e6db74">&#34;Can&#39;t set key on immutable instance&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __delitem__(self, key):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> FrozenException(<span style="color:#e6db74">&#34;Can&#39;t delete key on immutable instance&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __reversed__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> FrozenException(<span style="color:#e6db74">&#34;Can&#39;t reverse on immutable instance&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_frozen_class</span>(klass: Type[object], attrs: List[str]):
</span></span><span style="display:flex;"><span>    frozen_class <span style="color:#f92672">=</span> type(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Frozen</span><span style="color:#e6db74">{</span>klass<span style="color:#f92672">.</span>__name__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        (klass, FrozenBase),
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;__slots__&#34;</span>: tuple(),
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">**</span>{attr: <span style="color:#66d9ef">None</span> <span style="color:#66d9ef">for</span> attr <span style="color:#f92672">in</span> attrs}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> frozen_class
</span></span></code></pre></div><p>When calling from the
<a href="https://github.com/diegojromerolopez/gelidum/blob/main/gelidum/freeze.py">freeze function</a>,
a mutual recursive function is called, calling the version of
freeze for the class of each one of its attributes. The base cases of the recursive function call are the following ones:</p>
<ul>
<li>object is builtin type: return the object, no change is needed.</li>
<li>object is bytearray: return a bytes copy.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">freeze</span>(obj: Any, inplace: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isbuiltin(obj):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> obj
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    class_name <span style="color:#f92672">=</span> type(obj)<span style="color:#f92672">.</span>__name__
</span></span><span style="display:flex;"><span>    freeze_func_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;__freeze_</span><span style="color:#e6db74">{</span>class_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    this_module <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[__name__]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> hasattr(this_module, freeze_func_name):
</span></span><span style="display:flex;"><span>        freeze_func <span style="color:#f92672">=</span> getattr(this_module, freeze_func_name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> freeze_func(obj, inplace<span style="color:#f92672">=</span>inplace)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(obj, object):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> __freeze_object(obj, inplace<span style="color:#f92672">=</span>inplace)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;object of type </span><span style="color:#e6db74">{</span>obj<span style="color:#f92672">.</span>__class__<span style="color:#e6db74">}</span><span style="color:#e6db74"> not frozen&#34;</span>)
</span></span></code></pre></div><p>You may have seen the <strong>inplace</strong> parameter, having it with a True value
will make to freeze the current objects when possible (e.g. builtin objects
cannot be frozen). Passing a False value (its default value) will make
frozen copies instead.</p>
<h1 id="how-to-use-it">How to use it</h1>
<p>Using gelidum is very easy, import the method freeze and call the object
you want to make immutable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> gelidum <span style="color:#f92672">import</span> freeze
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>my_frozen_object <span style="color:#f92672">=</span> freeze(my_object, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> id(my_frozen_object) <span style="color:#f92672">==</span> id(my_object)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>my_frozen_copy <span style="color:#f92672">=</span> freeze(my_object, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> id(my_frozen_copy) <span style="color:#f92672">!=</span> id(my_object)
</span></span></code></pre></div><p>Remember, as you can see above, you can freeze your object
in the same object (if possible), or freeze your object
in a new copy. Asserts are added to make it clearer.</p>
<p>If you want to check other examples, please see the
<a href="https://github.com/diegojromerolopez/gelidum/blob/main/tests/gelidum_tests/test_freeze.py">tests of this freze function</a> where you can see different use-cases.</p>
<p>There is also a decorator to freeze input params. But at the moment is a bit
limited as all *args attributes will be frozen and you can only choose what
**kwargs attributes are frozen by passing the names of that attributes in
the params input parameter.</p>
<h1 id="why-did-you-do-this">Why did you do this?</h1>
<p>Well, having worked with Ruby in the past, I loved how the objects have
a freeze method and, although, its intended use was to make strings and
constants immutable, it inspired me to expand the concept to any object
and with a deep-freeze. However, I did it Python as you can see as is
my current to-go programming language nowadays.</p>
<h1 id="is-it-safe">Is it safe?</h1>
<p>There are some tests in the package but I have classified this package
as alpha. I have not tested in production environments with concurrency and
parallelism, so there is no warranty of working 100% fine.</p>
<p>Thus, I have tested with the CPython interpreter, I have not checked it with
pypy, although it should be working perfectly as this module is pure-python.</p>
<p>However, if you find a bug, feel free to open an issue in the project&rsquo;s
page and will take a look at it as soon as possible.</p>
<h1 id="conclusion">Conclusion</h1>
<p>This post shows a project with the intent of making immutable objects (<em>freezing objects</em>)
more easier. Its current release is alpha but all use-cases that have been tested
have been successful.</p>
<p>If you want to work this package, or find any bug, create an issue and I will take a look
without any doubt.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/immutability/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">immutability</a>
   </li>
  
   <li class="list di">
     <a href="/tags/python/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">python</a>
   </li>
  
   <li class="list di">
     <a href="/tags/project/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">project</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/2015/08/concurrency-and-third-party-libraries/">Concurrency and third party libraries</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://diegojromerolopez.github.io/" >
    &copy;  Diego J.'s Software Tar Pit 2022 
  </a>
    <div>
<div class="ananke-socials">
  
    <a href="true" target="_blank" class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel="noopener" aria-label="follow on RSS——Opens in a new window">
      
        <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path id="scale" d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>

</span>
      
<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000"  xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;"/>
</svg>
</span></a>
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
