<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Improve your programs performance with backgroundlog - Diego J.'s Software Tar Pit</title>
<meta name=description content="Improve your programs performance with backgroundlog backgroundlog is a library that allows you to use a background thread to write log messages. The idea for that is to be transparent to the developer, in the sense that they do not need to worry about async functions, the event loop, or managing threads.
Introduction The other day I was having a conversation with another software engineer about how to read lines from a file and write in another file in the most performant way possible.">
<meta name=author content="Diego J. Romero-López"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Diego J.\u0027s Software Tar Pit","url":"https:\/\/diegojromerolopez.github.io"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/diegojromerolopez.github.io"}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/diegojromerolopez.github.io","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/diegojromerolopez.github.io\/blog\/2025\/07\/improve-your-programs-performance-with-backgroundlog\/","name":"Improve your programs performance with backgroundlog"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Diego J. Romero-López"},"headline":"Improve your programs performance with backgroundlog","description":"Improve your programs performance with backgroundlog backgroundlog is a library that allows you to use a background thread to write log messages. The idea for that is to be transparent to the developer, in the sense that they do not need to worry about async functions, the event loop, or managing threads.\nIntroduction The other day I was having a conversation with another software engineer about how to read lines from a file and write in another file in the most performant way possible.","inLanguage":"en","wordCount":1096,"datePublished":"2025-07-12T00:00:00","dateModified":"2025-07-12T00:00:00","image":"https:\/\/diegojromerolopez.github.io\/img\/diegoj-logo.png","keywords":["software, library"],"mainEntityOfPage":"https:\/\/diegojromerolopez.github.io\/blog\/2025\/07\/improve-your-programs-performance-with-backgroundlog\/","publisher":{"@type":"Organization","name":"https:\/\/diegojromerolopez.github.io","logo":{"@type":"ImageObject","url":"https:\/\/diegojromerolopez.github.io\/img\/diegoj-logo.png","height":60,"width":60}}}</script>
<meta property="og:title" content="Improve your programs performance with backgroundlog">
<meta property="og:description" content="Improve your programs performance with backgroundlog backgroundlog is a library that allows you to use a background thread to write log messages. The idea for that is to be transparent to the developer, in the sense that they do not need to worry about async functions, the event loop, or managing threads.
Introduction The other day I was having a conversation with another software engineer about how to read lines from a file and write in another file in the most performant way possible.">
<meta property="og:image" content="https://diegojromerolopez.github.io/img/diegoj-logo.png">
<meta property="og:url" content="https://diegojromerolopez.github.io/blog/2025/07/improve-your-programs-performance-with-backgroundlog/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Diego J.'s Software Tar Pit">
<meta name=twitter:title content="Improve your programs performance with backgroundlog">
<meta name=twitter:description content="Improve your programs performance with backgroundlog backgroundlog is a library that allows you to use a background thread to write log messages. The idea for that is to be transparent to the …">
<meta name=twitter:image content="https://diegojromerolopez.github.io/img/diegoj-logo.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:site content="@diegojromerolop">
<meta name=twitter:creator content="@diegojromerolop">
<link href=https://diegojromerolopez.github.io/img/favicon.ico rel=icon type=image/x-icon>
<meta name=generator content="Hugo 0.91.2">
<link rel=alternate href=https://diegojromerolopez.github.io/index.xml type=application/rss+xml title="Diego J.'s Software Tar Pit"><link rel=stylesheet href=https://diegojromerolopez.github.io/css/katex.min.css>
<link rel=stylesheet href=https://diegojromerolopez.github.io/fontawesome/css/all.css>
<link rel=stylesheet href=https://diegojromerolopez.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://diegojromerolopez.github.io/css/main.css><link rel=stylesheet href=https://diegojromerolopez.github.io/css/fonts.css><link rel=stylesheet href=https://diegojromerolopez.github.io/css/syntax.css><link rel=stylesheet href=https://diegojromerolopez.github.io/css/codeblock.css><link rel=stylesheet href=https://diegojromerolopez.github.io/css/photoswipe.min.css>
<link rel=stylesheet href=https://diegojromerolopez.github.io/css/photoswipe.default-skin.min.css>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top navbar-custom">
<div class=container-fluid>
<div class=navbar-header>
<button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://diegojromerolopez.github.io>Diego J.'s Software Tar Pit</a>
</div>
<div class="collapse navbar-collapse" id=main-navbar>
<ul class="nav navbar-nav navbar-right">
<li>
<a title=Blog href=/>Blog</a>
</li>
<li>
<a title=About href=/page/about/>About</a>
</li>
<li>
<a title=Tags href=/tags>Tags</a>
</li>
<li>
<a href=/es lang=es>es</a>
</li>
</ul>
</div>
<div class=avatar-container>
<div class=avatar-img-border>
<a title="Diego J.'s Software Tar Pit" href=https://diegojromerolopez.github.io>
<img class=avatar-img src=https://diegojromerolopez.github.io/img/diegoj-logo.png alt="Diego J.'s Software Tar Pit">
</a>
</div>
</div>
</div>
</nav>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header class=header-section>
<div class="intro-header no-img">
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<h1>Improve your programs performance with backgroundlog</h1>
<span class=post-meta>
<i class="fas fa-calendar"></i>&nbsp;Posted on July 12, 2025
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Diego J. Romero-López
</span>
</div>
</div>
</div>
</div>
</div>
</header>
<div class=container role=main>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<article role=main class=blog-post>
<h1 id=improve-your-programs-performance-with-backgroundlog>Improve your programs performance with backgroundlog</h1>
<p><a href=https://github.com/diegojromerolopez/backgroundlog>backgroundlog</a> is a library that
allows you to use a background thread to write log messages.
The idea for that is to be transparent to the developer, in the sense that they do not need
to worry about async functions, the event loop, or managing threads.</p>
<h2 id=introduction>Introduction</h2>
<p>The other day I was having a conversation with another software engineer about how to read lines
from a file and write in another file in the most performant way possible. Take in account that
the file was supposed to have several GB of information and we could not block the flow.</p>
<p>When you face this kind of issues, the basic solution is to use some kind of thread that can be
unblock the main flow. In the case of the file, there was also the difficulty of having
to keep the order, but more or less, expensive I/O operations usually means threads.</p>
<p>This got me thinking that threading has the issues we all know: synchronization and sharing
information. But, what about the operations that did not have any of those? What about
I/O operations that we need to do but whose result we are not interested?
Could we <em>embarrasingly</em> implement something to provide tiny improvements to the main program flow?</p>
<h2 id=logs>Logs</h2>
<p>So that got me to the logs. The logs are usually written in disk, and is an operation that is repeated many times.
We also write logs in our programs and we do not consider the cost of that when we have loops or many log calls.</p>
<p>In the case of OTEL, the opentelemetry library groups several spans in a batch and delivers
it to the OTEL collector with background threads.</p>
<p>Could I just do the same with the logs but removing the batch writes?
Even easier than what the opentelemetry developers created.</p>
<h2 id=the-design>The design</h2>
<p>My first thought is to make use of the async create_task, but the virality nature of async makes it one
of my not-favourite things.</p>
<h3 id=wrapping-a-logging-handler>Wrapping a logging handler</h3>
<p>I also wanted to pass a standard <a href=https://docs.python.org/3/library/logging.handlers.html>logging handler</a>
to this new background thread-based handler to avoid having to worry about how the log records are
actually delivered (<em>emitted</em> in the jargon of Python logging). Why should the responsibility of the emission
of the log records be owned by a threaded managing system? Let&rsquo;s not mix things up.</p>
<p>So I decired to just pass a logging handler to the initializer:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python> <span style=color:#66d9ef>def</span> __init__(
        self,
        wrapped_handler: Handler,
        <span style=color:#75715e># ...</span>
    ) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
    <span style=color:#f92672>...</span>
</code></pre></div><h3 id=using-a-synchronized-queue>Using a synchronized queue</h3>
<p>So I decided to use a background thread with a queue, and process the logging records in an ordered fashion.
To enforce this order, I would just use a <a href=https://docs.python.org/3/library/queue.html>Python queue</a>.
It is thread-safe and provide a way of keeping the log record order.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>        <span style=color:#75715e># Inside the __init__ method</span>
        self<span style=color:#f92672>.</span>__queue: Queue[LogRecord] <span style=color:#f92672>=</span> Queue(maxsize<span style=color:#f92672>=</span>queue_size)
</code></pre></div><h3 id=the-main-actor--the-background-thread>The main actor: the background thread</h3>
<p>The main idea is to put the log records in the queue and have a thread get the items from the queue and
<em>emit</em> (usually write to disk).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#75715e># This is the background thread loop</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__feeder_loop</span>(self) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
        <span style=color:#66d9ef>while</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>__stop_event<span style=color:#f92672>.</span>is_set() <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>__queue<span style=color:#f92672>.</span>empty():
            <span style=color:#66d9ef>try</span>:
                record <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__queue<span style=color:#f92672>.</span>get(
                    block<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
                    timeout<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>__flush_interval,
                )
                self<span style=color:#f92672>.</span>__handle(record)
            <span style=color:#66d9ef>except</span> Empty:
                <span style=color:#66d9ef>continue</span>
</code></pre></div><p>Of course this could be improved by grouping the log records, but I do not care for this first version.</p>
<p>The __handle method is just calling to the wrapped handler emit method (writing to a disk, usually):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__handle</span>(self, record: LogRecord) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
        <span style=color:#66d9ef>try</span>:
            self<span style=color:#f92672>.</span>__wrapped_handler<span style=color:#f92672>.</span>emit(record)
        <span style=color:#66d9ef>except</span> self<span style=color:#f92672>.</span>EMIT_ERRORS:
            self<span style=color:#f92672>.</span>__wrapped_handler<span style=color:#f92672>.</span>handleError(record)
</code></pre></div><h2 id=and-what-about-the-possible-issues>And what about the possible issues?</h2>
<p>I decided to do a clear separation among the log entries that we can afford to lose, and the ones that not.
The critical and error messages cannot be lost, the others&mldr; Well, in the event of a catastrophe, they could be.</p>
<p>So I decided to allow some configurability about what should be done in the case of some log records of the desired
levels not be able to be delivered to the internal queue:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#75715e># Overwriting of the logging.Handler emit method</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>emit</span>(self, record: LogRecord) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
        <span style=color:#66d9ef>if</span> record<span style=color:#f92672>.</span>levelno <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>__blocking_levels:
            self<span style=color:#f92672>.</span>__blocking_queue_put(record<span style=color:#f92672>=</span>record)
        <span style=color:#66d9ef>else</span>:
            self<span style=color:#f92672>.</span>__non_blocking_queue_put(record<span style=color:#f92672>=</span>record)
</code></pre></div><p>We could define some critical levels that need to be writen to the queue, the others could be lost.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#75715e># The initializser of the ThreadHandler where you could define what levels need to have a blocking</span>
    <span style=color:#75715e># delivery to the queue</span>
    <span style=color:#66d9ef>def</span> __init__(
        self,
        wrapped_handler: Handler,
        queue_size: int <span style=color:#f92672>=</span> DEFAULT_QUEUE_SIZE,
        blocking_levels: set[int] <span style=color:#f92672>|</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>,
        blocking_timeout: float <span style=color:#f92672>|</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>,
    ) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
    <span style=color:#f92672>...</span>
</code></pre></div><h2 id=end-of-act>End of act</h2>
<p>What I did not have very clear was the cleaning up of the used resources, luckily, we have a
way of defining functions to run at the termination of the program by using
<a href=https://docs.python.org/es/3/library/atexit.html>atexit</a>.</p>
<p>So by leveraging atexit, we could register a private method to be run at termination:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#66d9ef>def</span> __init__(
        self,
        wrapped_handler: Handler,
        queue_size: int <span style=color:#f92672>=</span> DEFAULT_QUEUE_SIZE,
        blocking_levels: set[int] <span style=color:#f92672>|</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>,
        blocking_timeout: float <span style=color:#f92672>|</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>,
        flush_interval: float <span style=color:#f92672>=</span> DEFAULT_FLUSH_INTERVAL,
        shutdown_timeout: float <span style=color:#f92672>|</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>=</span> DEFAULT_SHUTDOWN_TIMEOUT,
    ) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
        super()<span style=color:#f92672>.</span>__init__()
        <span style=color:#75715e># ...</span>
        atexit<span style=color:#f92672>.</span>register(self<span style=color:#f92672>.</span>__close)

</code></pre></div><p>And the cleaning up function, that sends the stop event to the thread and
waits until it ends.</p>
<p>It also closes the logging handler.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__close</span>(self) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
        self<span style=color:#f92672>.</span>__stop_event<span style=color:#f92672>.</span>set()
        self<span style=color:#f92672>.</span>__feeder<span style=color:#f92672>.</span>join(timeout<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>__shutdown_timeout)
        self<span style=color:#f92672>.</span>__wrapped_handler<span style=color:#f92672>.</span>close()
        super()<span style=color:#f92672>.</span>close()

</code></pre></div><h2 id=performance-improvements>Performance improvements</h2>
<p>By running a 100K log messsages in a loop, I have obtained the following performance gains:</p>
<h3 id=python-3153-with-gil>Python 3.15.3 (with GIL)</h3>
<pre tabindex=0><code>| Logging Handler               | Spent Time     |              | vs. Baseline |
|-------------------------------|----------------|--------------|--------------|
|                               | Mean Time (ms) | Std Dev (ms) |              |
| StreamHandler                 | 0.685          | 0.006        | baseline     |
| FileHandler                   | 0.685          | 0.018        | +0.03%       |
| ThreadHandler (StreamHandler) | 0.487          | 0.03         | -28.911%     |
| ThreadHandler (FileHandler)   | 0.475          | 0.002        | -30.66%      |
</code></pre><p>There is a ~30% of improvement when running the thread handler.</p>
<h3 id=python-3153t-without-gil>Python 3.15.3t (without GIL)</h3>
<pre tabindex=0><code>| Logging Handler               | Spent Time     |              | vs. Baseline |
|-------------------------------|----------------|--------------|--------------|
|                               | Mean Time (ms) | Std Dev (ms) |              |
| StreamHandler                 | 0.539          | 0.004        | baseline     |
| FileHandler                   | 0.545          | 0.013        | +1.109%      |
| ThreadHandler (StreamHandler) | 0.344          | 0.002        | -36.301%     |
| ThreadHandler (FileHandler)   | 0.339          | 0.001        | -37.118%     |
</code></pre><p>There is a ~36% of improvement when running the thread handler. +6% with respect of the
Python version with GIL.</p>
<h2 id=conclusion>Conclusion</h2>
<p>I have created a simple library that allows you to send a the logging writes to a background thread.
The performance gains are of about 30%-36% of time.</p>
<p>I want to continue working on that, and I am open to feedback!</p>
<div class=blog-tags>
<a href=https://diegojromerolopez.github.io/tags/software/>software</a>&nbsp;
<a href=https://diegojromerolopez.github.io/tags/library/>library</a>&nbsp;
</div>
</article>
<ul class="pager blog-pager">
<li class=previous>
<a href=https://diegojromerolopez.github.io/blog/2025/07/when-are-full-software-rewrites-needed/ data-toggle=tooltip data-placement=top title="When are full software rewrites needed?">&larr; Previous Post</a>
</li>
</ul>
</div>
</div>
</div>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center footer-links">
<li>
<a href=mailto:diegojromerolopez@gmail.com title="Email me">
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://github.com/diegojromerolopez title=GitHub>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://twitter.com/diegojromerolop title=Twitter>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href=https://linkedin.com/in/diegojromerolopez title=LinkedIn>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a href title=RSS>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
<p class="credits copyright text-muted">
Diego J. Romero-López
&nbsp;&bull;&nbsp;&copy;
2025
&nbsp;&bull;&nbsp;
<a href=https://diegojromerolopez.github.io>Diego J.'s Software Tar Pit</a>
</p>
<p class="credits theme-by text-muted">
<a href=https://gohugo.io>Hugo v0.91.2</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
</p>
</div>
</div>
</div>
</footer><script src=https://diegojromerolopez.github.io/js/katex.min.js></script>
<script src=https://diegojromerolopez.github.io/js/auto-render.min.js></script>
<script src=https://diegojromerolopez.github.io/js/jquery-3.5.1.slim.min.js></script>
<script src=https://diegojromerolopez.github.io/js/bootstrap.min.js></script>
<script src=https://diegojromerolopez.github.io/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://diegojromerolopez.github.io/js/photoswipe.min.js></script>
<script src=https://diegojromerolopez.github.io/js/photoswipe-ui-default.min.js></script><script src=https://diegojromerolopez.github.io/js/load-photoswipe.js></script>
</body>
</html>